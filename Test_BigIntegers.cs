// Copyright Ryan Scott White. 2022, 2025
// Released under the MIT License. Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:
// The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.


#pragma warning disable IDE0051, IDE0050 // Ignore unused code and missing namespace
using System;
using System.Diagnostics;
using System.Numerics;
using System.Threading;
using System.Threading.Tasks;
using static BigIntegerSquareRoot;

internal static class Test_BigIntegers
{
    /// <summary>
    /// Performs several different kinds of test on the BigInteger Sqrt function.
    /// </summary>
    /// <param name="Sqrt">The delegate Function to test.</param>
    /// <param name="testTimeInSeconds">The time in seconds to run each test.[default=10 seconds]</param>
    /// <param name="randomMinBitSize">This will specify the minimum bit length for the random test. It will use the
    /// greater of this or the bit length that was achieved in the brute force testing.[default=0]</param>
    /// <param name="randomMaxBitSize">The maximum bit length for the random test.[default=5000]</param>
    /// <param name="runIndefinitely">Allows the final test, the random number test, to run indefinitely.
    /// [default=false]</param>
    /// <param name="print">Prints status and error information to the console window. [default=true]</param>
    /// <returns>Forms the average failure rate in double. (e.g. 3 in 10000 fails would return 0.0003)</returns>
    public static double TestBigIntegerSqrt(Func<BigInteger, BigInteger> Sqrt, int testTimeInSeconds = 10, int randomMinBitSize = 0, int randomMaxBitSize = 50000, bool runIndefinitely = false, bool print = true)
    {
        long BruteForceStoppedAt = 0;
        int RAND_SEED = 26;// new Random().Next();
        int failCount = 0;
        BigInteger temp = BigInteger.Parse("123");
        Stopwatch sw = new();
        long testCt = 0;

#if DEBUG
        int MaxDegreeOfParallelism = 1;
#else
        int MaxDegreeOfParallelism = Environment.ProcessorCount;
#endif

        if (print) Console.Write($"\r\n=================== TESTING: {Sqrt.Method.Name} =======================");

        ///////////////// Verification 1 - Testing Common Numbers with issues /////////////////
        if (print) Console.Write("\r\nVerification 1: Testing Common Numbers with issues: ");

        try
        {
            temp = Sqrt(-1);
            failCount++;
            if (print) Console.WriteLine($"Failed for value -1 !!!!!!!! - Returned {temp} and not an error.  FailCount: {failCount}");
        }
        catch (Exception) { }
        try
        {
            temp = (BigInteger)double.MinValue + (BigInteger)double.MinValue;
            temp = Sqrt(temp);
            failCount++;
            if (print) Console.WriteLine($"Failed for value (double.MinValue + double.MinValue) !!!!!!!!!!!!!!!!! - Returned {temp} and not an error  FailCount: {failCount}");
        }
        catch (Exception) { }

        TestSpecificValue(Sqrt, "0",
            !print ? null : $"Failed on sqrt({temp})!!!!!!!!!!!!!!!!!", ref failCount);

        TestSpecificValue(Sqrt, "1",
            !print ? null : $"Failed on sqrt({temp})!!!!!!!!!!!!!!!!!", ref failCount);

        TestSpecificValue(Sqrt, "4503599761588224",
            !print ? null : $"Failed for sqrt(4503599761588224) - Math.Sqrt() Limitation!!!!!!!!!!!!!", ref failCount);

        TestSpecificValue(Sqrt, "4",
            !print ? null : $"Failed on sqrt(4)!!!!!!!!!!!!!!!!! ", ref failCount);

        TestSpecificValue(Sqrt, "15",
            !print ? null : $"Failed on sqrt(15)!!!!!!!!!!!!!!!!!", ref failCount);

        TestSpecificValue(Sqrt, "4332296397072526994426",
            !print ? null : $"Failed for sqrt(4332296397072526994426) !!!!!!!!!!!!!", ref failCount);

        TestSpecificValue(Sqrt, "144838757784765629",
            !print ? null : $"Failed for sqrt(144838757784765629)!!!!!!!!!!!!!!!!!", ref failCount);

        TestSpecificValue(Sqrt, "197120777410685286861723419348662720446983624468633941814867274161329731855",
            !print ? null : $"Failed for a big number 4!!!!!!!!!!!!!!!!! ", ref failCount);

        TestSpecificValue(Sqrt, "469219801800293764373197355969328553831984974596843971042368711922664472663701981746713137411270711303034626199044091413698918166643890203860091306664994072502482932661931411083539271868071588269998735494868914134645646190292788569954038367952474854129663",
            !print ? null : $"Failed for a invSqrt!!!!!!!!!!!!!!!!!", ref failCount);

        TestSpecificValue(Sqrt, "628585829943043711774780150124486302296386743285745807915546421548369772944349205519895063878854598279327388017081748928549003526040710666991887335679085821326590372431911569248580138566784523769649934299594659147063327786855481652768517809939447427274571843102808731405570448808757614071",
            !print ? null : $"Failed for a big number 3!!!!!!!!!!!!!!!!! ", ref failCount);

        TestSpecificValue(Sqrt, "179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858368",
            !print ? null : $"Failed for value Double.Max !!!!!!!!!!!!!!!!!", ref failCount);

        TestSpecificValue(Sqrt, "179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986049910576551282076245490090389328944075868508455133942304583236903222948165808559332123348274797826204144723168738177180919299881250404026184124858369",
            !print ? null : $"Failed for value Double.Max + 1 !!!!!!!!!!!!!!!!!", ref failCount);

        TestSpecificValue(Sqrt, "179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986050859197892009348423098673397576100060199749986929562362761314132383880020795324759350467498370284959417336104341480439649700322878491181830478233599",
            !print ? null : $"Failed for value Double.Max + some 1 !!!!!!!!!!!!!!!!!", ref failCount);

        TestSpecificValue(Sqrt, "179769313486231570814527423731704356798070567525844996598917476803157260780028538760589558632766878171540458953514382464234321326889464182768467546703537516986050859197892009348423098673397576100060199749986929562362761314132383880020795324759350467498370284959417336104341480439649700322878491181830478233600",
            !print ? null : $"Failed for value Double.Max + some 2 !!!!!!!!!!!!!!!!!", ref failCount);

        TestSpecificValue(Sqrt, "4158778369644239253144735435452135103052920040777068394326845749479928668137113273641891938414472777155402871106641843416775631184591761508954289137159646589762108986911327059013268970766061512895207495793891523453588504760273949467854779946180645436561957963870029200019077271901983439750690458982602101659773464708927882431821592294995304801341476291809490825735434728904816304538249047761794496268396415473815044527283546569535324502176951155143748970420841309367267113066246134610984581041136088216956464090974746565616023221",
            !print ? null : $"Failed for a big number 4d - failed with round up!!!!!!!!!!!!!!!!!", ref failCount);

        TestSpecificValue(Sqrt, "17494584706016591027735461995965655369485392135483279753178087315506247479908101322432716538350151127201566210005644237814513392249452453615066147272228907663966390734640115862609428708808030883561312370933224354989584163634780158683901786449438459917087336832199985240528014645163631305415749573655211490978631716429164715576326122339425754435169992953750485069221610238394718337618921655783782041008005224393274487002390986157125495569904504979630450742020277163243700439394100971116982469820853805921150898151992772979321237326399758133",
            !print ? null : $"Failed for a big number 1!!!!!!!!!!!!!!!!! ", ref failCount);

        TestSpecificValue(Sqrt, "324869344822123891204500737190540217603582230298827943613070138634574543931529836644908557280814426421865640009546187334173413368040022188428404427615158419933534601057247685980219135338184905291081445059428169291870657858169275815840222956732487620761154654410650902413711236901782615917737119907905229234946211961080658388960638760959363844640743773892304002116832698921887645232477218304189719735593244966041503279433593532306881416962517923413587821230750081023226603959650598328121575017362314407084534778367861380310792005727284136781374900887396549343",
            !print ? null : $"Failed for a big number 2!!!!!!!!!!!!!!!!! ", ref failCount);

        TestSpecificValue(Sqrt, "105304873411458465237823109840830461532297664641861909345335983651620697961501875992724194244954865033669992328452594774452926688664213255617325573108242413961035542821302346985592911344125656037430417857923745187297258902871436992889265964566408383242965076143762182878415696697321419732252675577742829165177250146537026239309456512322120322660658657500735460842080634302497836781370951570897343811129414613636887318514067098255516234127025764803768697992519955839169838829708639416834170285096476387342434255498654317390346575985930158243128857324460324557274293835174709332634562827897313",
            !print ? null : $"Failed for a big number 4c - failed with round up!!!!!!!!!!!!!!!!!", ref failCount);

        TestSpecificValue(Sqrt, "62362385618440558416947016669824906883813410011053641792946485497339721329431721439415220243379222918320766404281447700590021891155050265114385592812878735466325208888593348836073537528761371853341648068552950252434358013341985391327537178373087155201768599524019380757016544450988505261122166827623821157388989385416619683557220268832127834874073559435984144961254858185346608192576658054546623242322471196316756094923811160906264371131392381779320586622639793335662752727861825331393639498034265911346139282451973559648859868126280816483538209855193358838624452241451974573654740521140261037836393493195199235018766811286482795967197478000411576883345741508867320043804212855588444336753360390022381829058493004310313059457501659510131594527812649374332829267428993258110432996432011983126655315265920566458028478121477367097244510948421854062842203915600005914824",
            !print ? null : $"Failed for a big number 4b!!!!!!!!!!!!!!!!!", ref failCount);

        TestSpecificValue(Sqrt, "65785897164448191381343511924499180834109624990100754110346692714720833794182365156704520567066494452568598038317099669513516096681618601973599684423150328823149127367318079223120613816366038825604373268484954782110429835105286425333570541703714024151532084137071597682869259489221172755742364472724201391713876228852531646764843076854104581946061772267221757994736893926938160629380056553372248214368909504039212458266423980657106363733011856061121104369672147994640441778258160341955435109744447134256187215376894548013860157067815014854327054401293768815922507649024668392519266407522576716874831315048731693618952003216023606499644720147295275387516119527423680540664128864272031313852922193652901872732314717832642396584320613044874876038709312185088372090147112187657869779392688566837197222873583961493636492878943080433802748761360310302723190158716092892744929758873685478975276800670405063542783787175166169602615999466339596354504219501105673891354573209038920435930403019087822420187428656762642041998808872161199084947727133936559102364496735902940200177931856797143955996184320324843305825519761471929663872341396515529983727108459536090173169742307430044945248663781699303787795654384125310492475708658293822181665360",
            !print ? null : $"Failed for a big number 4a!!!!!!!!!!!!!!!!!", ref failCount);

        TestSpecificValue(Sqrt, "3069442491521288882209912198117542685828244445905690595315578257576026925040003666991889175682390308936323311867038463231490746054685241129120234622000159636586371418712969328339618031154071244120791357576614510041502582933263867565326846833636258354336203659164264481477059261848349918717073176414771008286700543434325474444449281438222251793946891850998116797072652530702407793152000333188429567050812235397506192494548530491291118797409487643364978182787322328448530443362866083337031188757267098345726710434955949268377737390836920451119678791106540362808087964617692057966401075660464587924580608108398968250310775222716116115842124693003674389514501976582298711620937002974383619569023753418480367573767467109933985464413077005010973797700627360476030427905268125619163045870901316889850082561993497291168719068022883738752815867042916842718745541070994482039679939849686799177261959589642760853561386332687951825763396656135637366729975121257639567151942569081995138008253909141260694278219504247960643385039649932729611760156050269813026751925974222070054700377476339563378936752904193074400715127888611166019389931458008378123152360189049273713791950489010801943196670458698643779919030483832749037450457276224893004054165699247691719595414641725657814253155441724928627136906173465867833310562416506605962220212469680743631195003521103634050821337603560290588301701596040865889503083855843394986557884944945556100592904055449870116267151820289881744593737669145921716277253162110565422264986362809375302374514493691147107428092182615316212264678504594536231491812159439899029724642495322419784462312727216082735303318714472464191610452544028257508441799798931762864864715988018364678947840698415064282872338622653781614921843768477383401228088830160953321885774522233387402007516375459644536393505823116638100179333621321400095017611673388059841225689604612490060851053572095213627696433778410111379957067154748095781374936736446450881740690435307309763773395445323295974928890549503947240983765416438316292872409377918246887291176323662563458868858131452555217996657788702611398299641850553371541552427242564221750854980931902962012028686635547627516089966407286156561459813332159539037150419561327879678933483017892715686205036514841614923381597298214857688978080050309895836002372073116267988189697095225265014606447202687121366873422812010046203954155446406512176497398958902199187683934954505035177942270807666234260421784563099426565436213900626105750326879387331585783621735516159883149795298060197599003338404202019864250034904388846601666103456534799784513665424523093761686490311179806863884227268082845554028485641071881186667339630420990536348033811374573518685174498776199153952807285764157483964672560582276713403379743570822639933025397481655098408886282660023171993551106296385527170701183133777672093213188738741694934044983293582924711799227280747933936423952460643954522511189432838833992318133436093402215845142128199633596734427838667731079213697705985167700880000426168834509392875445367485856653591422112711060014993723631726287025250240528933012106273768378351138500715338161989228016080116459136734216724127503205822742783332823682994022186248905883173293824075574351709860643483188378501317242065384232733643703800477007671245506506448819409132040977872161817999289756235480194523522496361207573434686161257665534400673589353120197460876437504167055219100215867602411096460412229429079285626829687313455227071378556727057753271604205993856464497871129467229025429547074215802004078323994886093651496186600662753953467748733605822112764756889732419163666430200039786738275552439772076955582989558501826698699205244307930848801928945717786923638908737879755698526580886002753749119517824311199565239535459743495944328212082804476388179843223579058132576774434884138498280414395932009691578799908458223727862462162517348267792744797120556934452160358567208951294773492750488980597538249497239502805023275074583865176885646664231279436272375097671515831792480205586694323948514674819096158241914861084086730146230038029178925903687272115333804362120993281043507953301957264579715851946913744157249804950757134088225209081331103699928306372835734613537073408836283565648493538290450219281361986271155570178995901695603037671788303630750211538625719029474791732114270982436148244502475225987625453208430820423770243728495708993385732000987834633973038968332320682403779372533185282387350736003580916668556752016226984103964817708169764367301733647432713197376702796924072209926215015200903604895412233023052040791250206901139981495026716929835988480330322955182770954165349145460676151947470528933066854293732077126911806037025514262502175217341119266516935266970430435686586687221511704044830195876803951216886191712932361996208153966591637741058854115931984726926395471877234990804321123897818679943442005331229659361006123821003682184718600964631416525432858662586103439119832901378590593488273914589529522529168098354134329484105776576392869271043003588742911347032098816967613528209855168254288156486216138860890485199621231868083353369428916387229362205336191575119399643960239395501449162348659292602006106445609881542323651673071183576950962378623267489699018803623453089373045430854799441436465182350062274762844819766839146628622899174925631396268622996552154198489741293389968601416787938546938413000179187947660271807946308136433080654777244653137705506524778275973917002809188019744865561074857914262025366775107914959037947935316055300044685467269655480316211607691656997277221963296026571589420385702910093313956234014290580287470710740800775121991739227925815442621575357604714760366161961606852305033257363574874222642286664956773235526288930766467143544775887655158853924584028117436526969518661333800848727404137269125708724992245320013527102903032439454937686146731236236644251899955560076677364560719237051001636472139620263613990376764707323762058262951223961863679442545168037107687223160686841088157051652125145116511027972190682608974557596973280729330951543221824468877897232543355065149890320924240623526500984311167436811828770741517261326174152190194196160834894411398301516653057903996098096777350577210537813268640448546835519494688128611437628716320798087066624978464673815910444900519121937861886812690948622113194530651737717787102024458087792007794523529513738876821246810329817159823426901579562127006149066292928826792007136959549093470296877960511054614153437428961563399076934000170041285968076539471692045791436764662441026128845038670405435646801492180091809627139564644805409289569951372982624195987330279311945725064850280462255023304846430029411342844166104267344590648173000271835390536016874950730343758331221972309317221251083873750004791284489673470854881554429194332430130208106028264843456123903540591507890627066290509050419481208501414288030965549577962623556319068798301492261251326113621001381146549654755095578415942651955697937940689009059973557256823887040416614910041698289281109611472423623331742817915753811190461438227782075653120276478594477526225339946255836104882044580743650137870239234187836464406352370893081394437977780821196100379020558313651776799202087439820892790623511128549831346687683224237311167958904514270092980552226154995550845480935380293112607479761340761547283114189620347225879629121828399336942595360072519727479517809110113801510868580800944756922402988679535268864215546651144216923869194161620309679353954274724119563407615509947186724322271491339801422012052910420364096711158184569256957243892984936667615461215962807480664364324872427309070603063714655408970108816175305871355129023247072211288258896111680582765033139170345652688583109693191303861932309889301880553965895178485256684858090531178681802660545578070532890263020044650399744838839835926984266373841008645128966784789801878328782877224312920128429094887468565913728766636896482868230658705412665604959760522984666270503028367851555525820263015204327140619576239426253160534212233365371114016087577998805966396947967209534939295499686464591363743189264038467458309394783583068318447551901762866282068169491414836212699794010057728196877366801100127798605063880906462985085114675537",
            !print ? null : $"Failed on sqrt({temp})!!!!!!!!!!!!!!!!!", ref failCount);

        TestSpecificValue(Sqrt, "26110647385995331412530337741532381485186612256060903451990700867179385858319297989752735363838315916563360356390573775266583791609297042331748298228088056282193986373927573569987278788717688482155216259485832195609970573359635586100997192033282722319650294406293454441126992642016681160925603633103023370343005964809828346154266181696932225106921874511661431193499998490490929000986413836214826566928142035425940275418250291346161777842369756136380181678291946181837081950244784765257108921512599265804164416615924840851400353419989954496344561532782785566257875219987337692000776422075828756343140747293908685233103909004323566303390968146678557013121938300748315907875532935492654293648792431656403198451797580132855792317509082749139361868755218901264493057637592095520324300277074324546235008836133462330208390737169641048045392272163839361447080594650249565952568704136255263502783279879685051623868483611387544321557721224753942039057306777125503179746947028137549130730023206208398921939359057564505580796325323319163833388960527632576519659529262159818417961101459705966896570458026553914960240441414812838558877014156640805628900514556035849475639905348685428810985364853325099198858796314791385414151394024489766739042236961793869892871664271316731485381436741703855137793840671229612022912764766061280214988812839566471254625125990664249110192545944206094252706636515698735462473910724725250950927572795148244245885667455790020234217090084854485912875809257671327704697617213510423502463825582970682589326828236100537863426561896294215008786058018453553163889590405555535604973415428985616083370923709915982481277844322193684139840616565546038159471981419414311386081209212398130163064597484003696108685391813330209485314639753359185097223587525165955457420382815918758742821453663668158891137844397272329198224660367329103065637241182810507654033801677495469642129040427105245686199921169099265072142132571912140095519824140234732019287369827078075892907621678548722820679057861198649271731941856517646466859217092303248275974088113671704433534364400122314877127855117942844957156361980573614030917994935842884878356286078376489261198162145465033312952568377131102537775038919252255544226634955707679892817564032820102986037746845740781079489751974876160204319606399912736720942469438967554901929098926507004165463092735260104812591647750732572244130459498929616849686461663599010157261985667307412475718995082524468738189980381623620260160791773007161933327979725548127907478256462590554071125100841944910800657756417013774832981545731269987291991148685585841543616268863581584342472685116641459165962175596841921746068467555331910974897735390355346252128487999605682237960660003106609685497188256858751895002874308362943465138984775537673972276669809193991062622079377190296639027961712611736773744291781929979829328237135318734104989989668133395783451423744045499746513086332264212530785645742652991842970271750562613045111696657385029995352890246809116296831373412483992673210235742625310051530996475825730794474490492356458950841762635525986138115805633428722200257766611691534197384252488124526664744792480845034847709197193716623381454111253802204140922965663465426599282966387372041263128046724922126233112523587148089040854926176799347546275259722200691136988416907898400388627977640547122751789019326172945748040276867390998450555641541353784384619960383353011028590942904121879602128057208031878959023210204906912095554654328735175907143469672099313597969570261239816418759325106782223118561405031254248367322406858759690794953958205492039818623432732036676047984751894980403436036505941455005731194740237109204907221911165746441043080539598396251975257822686130913358467827290942571692154572333086114400875760577603133720421348457705830729509530752349559478526196702395223694814486212958427755605883573216141392750388758404126169957598497169963806293741193756959349827258532573464529207171429832648140549162717920930967162475179688187992413081951994683051951453558374559262840199473891621502753595480866354459845961159984496829393555991998342638792362089728620083758362203053781404721191148333959610755302774685101487107226294746837446687164791711877970169186926392620671313233637482999117521349684687298197773028636554146122050370389001256822232345937453418104838948736500756332741934681637619581184376497961746928417186837544208320984422110396534213405253692311209302920658569933593530625034616607217569244524728252618534840514704007758020126380655617004152052946918843416071097078659682895105041385566950008631210591225380680923119023133238632142709890279564490642195705539419722525615336348802732713758150377460279795639639200080805348318035021370892394316856118770373297148301528995249264474893431991412084265846586540966035079880967050056388331488947009138092610561149946608376550530911761032349194380659090496893567093153478532507057363005421253978929857149721893957558127423152839221390247640242134594176897492569104683460303001622116691853000614822801635903137162733634064362916335712329255106751156452197316084479122605450717432461208564043193754553766682495464315836094153985714434448701918249803776986264666602069986980444019865962686191885540732738467832987995937765016369081588110595992106154922553211672814000587466536536539071756777667226470807430762754873284110313550645625044645716320387679504138075750502278250134687042195378545230436221689992428989017684181244268275517141335454203545923929623829300315481391574091526676657961846399827460392648147600697844377383617583368617543217676836837673404159902012186063064652313530006900043794972290849645281056035547437927380799384832669839355381031397456871967118614220742572228488567979293821258831999646398490973356280519571320498277374633559451198237685084012207515936943069129631546649715436856713500613038698154761222073987824338239429565488347781927711792840244923854980246295722569724789172615587826286717667424431176334927502378317609072775442328705228866858219072203279819599928995802321032473371932996580168134530885809772962625399238798182618404439305603966552594580535968914998744260923572952190098623140436645034778307791261068723682140685915194159985918693324932290438847398168179135520074799834997303827985522946657679591271820663910644599334472343589810469588967842274128213113437603259139248821404180937911069055341290791635002194549461046779949593083601577414578915560637947374956555170306163337050028702997471612540919521018014709820560254637386208649713137325618658861267413334954498207081112859149412072229397304199619664138244163244226087317953973529928965256402855920129557041582219230594994866451665690613155965124750882225120299809279817065597643450956452983254831141272166187720583488918009549908701405568125890848542420635388293290074657331468190072984167293736832425031320379884455626532666267845836688409289956874474017880503090008538997654198985130361910997866472381000684598376552372767704875775681297198641022477287789208149458760618110318824230859623475166931082018130463423594122053610786592017995962097073359999448129167107269689650155430394867077377192471157577757991397416457837481289819205346163915677965594795756110462276828763263921088697099828528952897573924667950453964280184582037436609216480724969715588884534906873948972115233595662579212033984944428042166083908269251443208428109579167865324747799367991037513067852517353386416635311972038301102957392738060806703461963383208997369072829087909495264309854969425488341237800932192302482210242002608189571474935226006787620063628219014709848393529673594110307212321376197701998622644369743083660611774582779625813556793982269200342534305739250832429372264155747747090607352518840107141886604267069646919228222932005191512454667352467336734553661954346555918336770562237463436519879732232478265790801122459567822892730328670253714996797110716317979550656517940594155578528580129679367249403859208712128292248229549812030550239801728435366280182796152877413000185035179361983312592604649598439278960607129722302734618286012554918305825798218798031162040473020507747815679044275775830480889929912929837242082274381054071240597292250187014171605230220770261182488840272260590159459663573994441502112851681486643486876615493452546835193465418727485407225812749589708776384683032773138185404667177437893113816078933444364771427738088631483045043212030973000323289509628420822804400485214339072121671129121431048811197806462535565922977779438607716475131011945140151398012619209843556199107381781107706804192751346964458601726553221925056543588639643328633868690802354417555572674180099659791535042900683214129252265761362962551690699072552689716146657877394551983217045638246252523193390867676078792174489662886970804785054895968565391830659500509766923092662277068640276424543979053003016009694198025008565253670784320252805716801176826322413575034229301229547093530336730699303303243026869701619371123074696116256182829346672425753699209977467732741663979110098552118698891741963700352024327279798614887428672973765049681097908222453155631591821388361795074803819770598780133370392609463415413405852470320579889127457527144114537134105001934918588976561942196717416767233852439196803512077799693607692443990582723568631034135811919600290227966578149260038630071843427522085672010334870343303201422250611631716768690227709321126845458584125478103741601887672875186398463401694598091217962409785664571605540276058886570467626695992128374108025532003967511188152187585851224515961901566085264482194642312347778236342736527959877345808692359249941020543756085057862515653179593811437980330948337337710388235529478429928725109655231336622299062551864579898467326610145349605148007570127242373276291680664064768767559869156932749481241803847324129902990390489393010297811570191762936325451050914333561762664229409767027788188115699602861010684191751410498622198852333775024879669796654973250076412153274927415291",
            !print ? null : $"Failed for huge sqrt()!!!!!!!!!!!!!!!!!", ref failCount);

        TestSpecificValue(Sqrt, "568596673212406235539046204653574092779927528240990410308704492396460002250762210750361428976428226236231439839658527797601369407516351767038245884193317345297332639084030064798571562357325869523334241343457316070779167053230802243325508166810051970793029610805741205436326081505118688824250695502334609951573043497313485532249651668225178016840421469883558806604285808368323341479822807033581983205344039371458847573584264752900519079048915398981011181623230780288048890300634904517965949212204068737098107941104189698397409567698012505870983478073274795514339034169365773220230830720004807771185986855895045516625461415107861041712612909415282678933430993639015017973044506087648363018729847627791605903425315716867660373283634463025466898314552226041199227082594230096271404048950683874734785456093637644080259923926309749113053869920861252071824902816983919198943333352747567573205971722594392368757236981129345325357188283747755165211300361598909057331888013394644712040562578111312045020011010991816673666598318790155764029251076097495451756886293433937287357398346137053436703441717477280156524220517544784355270939618075800550360950261327034177704356076938995007627050124084857312674697721104308993667110188079684610462970532770811430407577836576516525347984663742735894854393178929653419127586692542189167843310656882269150136996004592038958466538491947533727965371911271931474363560773806290903082464818620463658436801310707825375068269725362589748265742091637498362621850566516960404061662197346676810108676564947944053523430298498377965136876382874888755098780874762932647407939626869067245075305802595524491063488862288004615122286564843300578758861996842723888825626998296253860396832728618268698513999105663450448455591453911622931238399649235353903164331408715648544484198462915062815114371906052899024506631206302172485246425734102246282006790515841269176368354750944457205740865919396101592164443131178363631180186481154637375276513183701970126748221898210963776797851581007115533834804644343822008468228860094391251339086238465678711921921284967851031385031907419916767858003766595842244869449534509496748434950293981618989570054257983701817992679002284807232891636649497294174834055117140618871480275671453660871756346174812413763546753450026532970380652053777318975717905464523846316531635812393163893169715944468523807676593337865609836993849998617745398537861679170415965793630853028066627328675239723557343598380919099547947117124600794798069455211709821342706038292764227379487605537218318247566029210526464224355667262491214506233857732726704711260425183953510241304266161977666456048204419815901425751876965458230836272990822362376876246567929545106942228163519038240884565231374383262437933921682301042259394323384010986971478111167473189572624136900260842462563632164438243406573308292515335842446029470620153455750269492648502995752698839327318101471308195682068310941060522835002396271185878639534383332814526736730627737675311440925963840167979468823970109167743381899347507787042067457538898702507081788658375961558876519917419284295948484882059236624597063874422807420548386494638142661819447373680561474726020600212494965888772592905717450857077427720367172542629011169439451164789672353614751341788973143362728269876015374623199859749885177199865505249137720400675981797711570054912715025084920361018230684483048532553044351189092760249689620742581712189291998116260173085751887604161409277198749738705418188423325214210791436123865095895924870449787198921748406270195538419589929583571270220608276936976047435099002481081568006269184926746075413902095833213112716082651523466102709809765278868521868323119552163151078268298543092909181764094354421443739939102266618363082870756251734285570963705511926675021687571952918187727056741057433095113623046731136780044772629021222742048526819043564191009305901298547848411807561630976907033779660614988066747079217915126796269532241434824559034294551034567089930561187776063042962098376001055021975735594097154610662494227608391831324251819834849972727806898988047156642000444156374099020509496337413749154812935620746943658043566102396889370920743841762392784731892754856936207021618371850662875222101060948251861698244863970080362619038241610264649305147250851826137983717857787292617945678440789654915586664827700527372511102728500979579398643014513213916697791050137689464063898748385088697075494961738641464073679536486848774189038880714063768855876078617505553790225908239315278348914126700695635803110855185780815614549031475503058796620205024302283909168380777135676289136283202774805599924261375761188156533898405212485642815583559044372013559333161812445651874731406291358975389500184031405897796170361475824855865416996816101180577179211466498528422630318977338028015876113173714172700603294777292007011893140268292139031620419978838233874410683183389592330610012298019178543866221491941389015906603598594523857857828887538768270002115444064670246189471105302854904357142640940815690815734212236064510656653497518955499351963564298916187123224379625736828158748021096975654285608875084594416617349440558333862887122384581582621428905712789260430593638211814462714113337065254852187384002227801421778675360047475402608367224990354216772160982391869523318958043157276234232215594952081263397029345447393215331410760682924198274455705944715191010466822858771476567511651447291833709417664994052378535962785039458646535298796251823002497493739453107285588189345055064989468830654731943635755096663118764896699043462398498063855211918516506112449276535417359689692816934359580186655249122981543576662853443920537700756370071176061687748929211550413374463270060822541705443889568085981718411771212910543081641827053808927056261093615521865229815551648410013951889654447956505928765294673621144189425512678052272847811478536361635041037247376079729955183288034878518775882046345262042085840029108259221965326603011451402215189442292326949370373918443853583166196123334746715570385322755860325668018143340905234499599661770553181685425109623262543554842563091462152389684151335425459512757268182388248548523806002139043631636292746232049543450881373125665610482569105547103522944485323651945010132405329295466906186502963615807071377352577596402482171032894689185345703931237197465495582572835620049008345615416894296528929647879711273709072418138224125107429443618724331758238114288955335876006203475145403711957920226577816782199167434890841283968630429187388429297294594396082808367568391279858533434198593052588130438526062765357196625443946092250933148070571533443620438382567098056574401350203053743912618224443564964963443981705183424089707049132420709512811684110954808225750117291699279190814324766521785636930646857218211339050239728030407504252402281110555437220027611206852489981972335663826111509206274876677013594436818577024753697807160957110918683574700041515759818141929214696536737555054156463211781351270996437552588723233229968280241742959860248850145435451592696399504097017400658966435059320799049397167451625262640117821825408096184107986323793568374539075737342874384546075573443054746055797583589009325216800125861872312825727671724348718906475191691504698280148131491140967107650139462912226865980464987962788562821048754369500679830978859725690019966684659376992815514045818430491026939697467871051042324292828993612736362860526073881154128878164128599611551530542310658302503782893657116944936194648228308865028057607312143533193693276156368189379813543149482685350792790900828570877584724011390068030679428412329640096515459755446277254206795751336660534427014290278841915158071763997616948849295574651034991146490119782815733533690996854686822010136733628846720978622539379847979030187244911605202840143861781982888178795784849924776497393293251973778927673416094397274685411386366555150802162781628659406215666823246623165293809466708313281347029191907077218303008657606493723248678087195932972884404760267321772756889788034941676516109268379862672702988397543495729736053680904777823723687628080981561711050363322368414855010665896948734225989419949098919172314701355903983867077527964924292955188146625777356737268809184825688808727316372675679905612856708689910533140809777396520507481327364392903800382176843167097065576641359796355206255921794399479538490606924139256862692724352340257725289913772940861331250854604953474112127163651856327913992832600123879966765945027720897535126324356794186885712704393607569538708105218104098849209423758863143894085086521731190291213196696379305734158272203101824107379076013035076712234971563844659606120406749074695967924573761014310011944566766342932466508424800571668641713486290921461220902791729023092771013548720715052229192246483610110598593104826970969087806572025329199569944106409193771552798814229945092476861583524722722759112066195996832270583763580479784998191784157314172850935658197344181379452332323193615353475333080892522126019108669481315395243573395324665363237446275972016556276331960182906303806899636009927546780543980346488212445140028771356388091942552442803773188008085351584825331255325030728733841409046107296730339245186862892760570481181616153002140782747878123422642967197887773195118140973221908721712441299887200866209083986770666824257088245624210982913142488708791987999144692110825246610047377251697461317512198538491122770376600660555409811367120173388378864060067155455090713541086467734664217720993609926519612776700477174101888188993458884880678252772213470425870780423917552701421891594456827968463820740935159076965202859200886098119890641044112881824831639132512603547695921402281940932405417994997938702814783404646751173368769430287371382741376186138486209145164636826028569305579088510904269435098378605169160732461767439018571424555136824347744527082607528180785762004430782108476943616681422686369572684280347505608117430283967292298696789525942300497917954715161971484652463862582725536721104119418568020996161818601764632840636654512368265608739854877931293276921822972877637476652414189723163275512609800132204020956071479807078747845492246682750495407588012902148137602445392176004165882375624372971093548185310117781416021878766399749320798339753778763002071834838306505750050805540210201136326020621556855005961134616936531575783426741040255892005909751600522657015249622142126076979990690329503176083139283356214159398656550117855920963884388077339193608835643128361137119861234131388516866300141373858812640966673370208976799490665174350806186760932933142007086682804757500330217466112164002695550502935300774079412928586340785624656954700151339024544642095334737169097624334788472340640760991267874048831593849530914907470681401965682331359610472406029801405712218159877957333208758173834527023282453958732806282317437672436010620079619244570903695496127956956370537136100022623247986844149235756854737785008277115265923928165200225322336346459556753143202165172227589300527336518245297791085001356912548092099238245360700904251961806593017791798456151653909623459064981589910213870726571579248087879927563066384322856888956287583958965883356240509710864472300769026240045989417656762302396004755336300292521981524065962669490439929857862990319598994639527337122261314730682010056463040758759229889469623898712489719894803269114736500294656194415411869308406146183676054911313131576490647259320992587418054623431837487101604749635114422516499029219293563309281873120759088798895107585724608028263483751331564960049361692704843923785240777313723141453380005341554361639106359775060438287533523856932311422822902626821353904546321484240526585044350171088733439015781558642861065686090670546148571755491286609432057060043971666742286929123667582156169592438262264874070917970547323393649441643765658590865329264618839034301964877180176616403723280116891858186445030814169336508840411566050522180360021655721892781045068966149022578480880921209467602646549684170791500075860710762219336741044349075645200291919578682567332551703896463617259078795321898551974712455647120157245246302781579972253305371481572681034639914639300323011324097949748477310566362105763912344548012887103371826153953590397376115194569981433472808913562082278719594578119855935945569601702547936472782015206840585788231913151015093662983988417437045652418696833683466810782825130439414165774425720297653926967414456360568582558597443506721014596982536734082869106415898445244563135907319363754872172732968447400156320191672297712593724792947325051014248915874773651986723659919087113447245598165982260966270996855626015566461178715461446100650588392938743410774620631872835529431975415586482202897851113697427399684025977623533827867513660088600035366734999866788911160860417088431720747173113244497590518629084473281861361283399287991613303988316391104279108152188690308248779942580210521290025393058453299589362878325391924052007947284168720206307284670229558925312818188165898373997681761608045055177236603993020863977914314891842571099458801905126172967955860909914918248496128402431735678905186029032850506351096008393724932390617611975528997095896345764537644314187545496811248642037001876864656020866004278021777761041348263458447185585845471066467853418222600902676527198074498128418084033054178895168187506127544181648175505145324458999126697899163798209934081",
            !print ? null : $"Failed for huge sqrt()!!!!!!!!!!!!!!!!!", ref failCount);
        
        testCt = 24;

        static BigInteger TestSpecificValue(Func<BigInteger, BigInteger> Sqrt, string value, string failMessage, ref int failCount)
        {
            BigInteger temp = BigInteger.Parse(value);
            if (!IsSqrt(temp, Sqrt(temp)))
            {
                failCount++;
                if (!string.IsNullOrEmpty(failMessage)) Console.WriteLine($"{failMessage} Result was {Sqrt(temp)} Result:{temp} FailCount: {failCount}");
            }
            return temp;
        }

        if (print) Console.Write($"...Done  Errors so far: {failCount}");

        ///////////////// Verification 2: Brute Force Testing: (0,1,2,3,4...) /////////////////
        if (print) Console.Write($"\r\nVerification 2: Brute Force Testing: (0,1,2,3,4...)");
        sw.Restart();
        //const long FULL_COVERAGE_TESTING_RANGE_MAX = (long)uint.MaxValue/2;// * 64; 
        for (long i = 0; i < long.MaxValue; i++) //0-138129003319
        {
            //if(printOutput) Console.Write($"\r\n.... {i * 1048576} to {i * 1048576 + 1048576}  fails {failCount}");
            Parallel.For(i * 1048576, i * 1048576 + 1048576, new ParallelOptions { MaxDegreeOfParallelism = MaxDegreeOfParallelism }, (x, s) =>
            {

                BigInteger root = Sqrt(x);
                BigInteger lowerBound = root * root;
                BigInteger upperBound = lowerBound + 2 * root + 1;
                if (x < lowerBound || x >= upperBound)
                {
                    double c = Math.Sqrt(x);
                    if (print) Console.WriteLine($"In: {(double)x} !!!!! {(lowerBound > x ? "Lo" : "Hi")}  In:{root}^2={x}  xShouldBe: {(double)c}");
                    failCount++;
                }
            });

            testCt += 1048576;

            if (i % 128 == 0)
            {
                if (print) Console.WriteLine($"{i}M");
            }

            if (sw.ElapsedMilliseconds > (testTimeInSeconds * 1000) * 0.25)
            {
                BruteForceStoppedAt = i * 1048576;
                if (print) Console.Write($"...Done  Errors so far: {failCount}  Up to: {i}M");
                break;
            }
        }
        //BruteForceStoppedAt = (long)6.6e9 3.24e11;  


        ///////////////// Verification 3: Testing 2^n + [-5 to +5] /////////////////
        if (print) Console.Write("\r\nVerification 3: Testing 2^n + [-5 to +5]: ");
        sw.Restart();
        for (long s = 0; s < long.MaxValue; s++)
        {
            Parallel.For(s * 512, (s * 512) + 512, new ParallelOptions { MaxDegreeOfParallelism = MaxDegreeOfParallelism }, (x, s) =>
            {
                //if (sw.ElapsedMilliseconds > (testTimeinSeconds * 1000) * 0.10) s.Stop();
                for (long i = -5; i < 6; i++)
                {
                    BigInteger testVal = BigInteger.Pow(2, (int)x) + i;
                    if (testVal < BruteForceStoppedAt)
                    {
                        continue;
                    }

                    BigInteger root = Sqrt(testVal);

                    BigInteger lowerBound = root * root;
                    BigInteger upperBound = lowerBound + (2 * root) + 1;

                    if (testVal < lowerBound || testVal >= upperBound)
                    {
                        failCount++;

                        // if was too small
                        if (testVal < lowerBound)
                        {
                            BigInteger root2 = Sqrt(testVal << 64);
                            if (print) Console.WriteLine($"too small with input {testVal} " +
                                $"{MiscTools.ToBinaryString(root2 >> 64)}.{MiscTools.ToBinaryString(root2 & ulong.MaxValue,64)}");
                        }
                        else // if was too large 
                        {

                        }
                        BigInteger correct = NewtonPlusSqrt(testVal);

                        if (print) Console.WriteLine($"testVal: 2^{x} + {i} failed. Miss by {root - correct} [FailCt: {failCount}]");
                        //Console.WriteLine($"testVal: {testVal} [{testVal.GetBitLength()}]");
                    }
                }
            });

            testCt += 128 * 10;

            if (sw.ElapsedMilliseconds > (testTimeInSeconds * 1000) * 0.25)
            {
                if (print) Console.Write($"...Done  Errors so far: {failCount}  Stopped at: 2^{s * 512}");
                break;
            }
        }


        ///////////////// Verification 4: Testing 11111[n]00000[n] /////////////////
        // 10000, 11000, 11100, 11110, 11111 length=5  ->   & (1<<(b=1 to len)-1) << (len-b)   
        if (print) Console.Write("\r\nVerification 4: Testing 11111[n]00000[n]: ");
        sw.Restart();
        int startAt = BitOperations.Log2((ulong)BruteForceStoppedAt) - 1;
        Parallel.For(startAt, 1000, new ParallelOptions { MaxDegreeOfParallelism = MaxDegreeOfParallelism }, (length, s) =>
        {
            if (sw.ElapsedMilliseconds > (testTimeInSeconds * 1000) * 0.05)
            {
                s.Stop();
            }

            for (int i = 1; i <= length; i++)
            {
                BigInteger v = ((BigInteger.One << i) - 1) << (length - i);
                BigInteger root = Sqrt(v);

                BigInteger lowerBound = root * root;
                BigInteger upperBound = lowerBound + 2 * root + 1;

                if (v < lowerBound || v >= upperBound)
                {
                    failCount++;
                    if (print) Console.WriteLine($"failed: {i} 0's  {length - i} 1's [FailCt: {failCount}]"); //  \t {lowerBound} < {counter} < {upperBound}
                }
                testCt++;
            }
        });
        if (print) Console.Write($"...Done  Errors so far: {failCount}");


        ///////////////// Verification 5: Testing 10101010101[n] /////////////////
        // 1,10,101,1010,10101 
        if (print) Console.Write("\r\nVerification 5: Testing 10101010101[n]: ");

        sw.Restart();
        Parallel.For(startAt, 10000, new ParallelOptions { MaxDegreeOfParallelism = MaxDegreeOfParallelism }, (length, s) =>
        {
            if (sw.ElapsedMilliseconds > (testTimeInSeconds * 1000) * 0.1)
            {
                s.Stop();
            }

            BigInteger v = 1;
            for (int i = 2; i < length; i += 2)
            {
                v = (v << 2) + 1;
            }
            if ((length & 1) == 0)
            {
                v <<= 1;
            }

            BigInteger root = Sqrt(v);

            BigInteger lowerBound = root * root;
            BigInteger upperBound = lowerBound + 2 * root + 1;

            if (v < lowerBound || v >= upperBound)
            {
                failCount++;
                if (print)
                {
                    Console.WriteLine($"\r\nFailed on a '10101010101..' test.  {length} [FailCt: {failCount}]"); //  \t {lowerBound} < {counter} < {upperBound} , offby: {root - c}
                    Console.WriteLine("Here is the output:");
                }
                //if ((Sqrt.Method).Name == "SunsetQuestSqrt") BigInteger c = Sqrt(v);
            }
            testCt++;

        });
        if (print) Console.Write($"...Done  Errors so far: {failCount}");


        ///////////////// Verification 6: Testing n^2 - (0,1) /////////////////
        //note: n^2 some overlap here with the "n^[2,3,5,6,7] + [-2,-1,0,1,2] Testing"
        if (print) Console.Write("\r\nVerification 6: Testing n^2 - (0,1)");
        sw.Restart();
        Parallel.For(0L, (2L << 25), new ParallelOptions { MaxDegreeOfParallelism = MaxDegreeOfParallelism }, (x, s) =>
        //for (long x = 0; x < (1<<30); x++)
        {
            if (sw.ElapsedMilliseconds > (testTimeInSeconds * 1000) * 0.1)
            {
                s.Stop();
            }

            long l = x * x;
            long h = l + 2 * x;
            if (h < BruteForceStoppedAt)
            {
                BigInteger valLo = Sqrt(l);
                BigInteger valHi = Sqrt(h);
                if (valLo != valHi)
                {
                    failCount++;
                    if (print) Console.WriteLine($"{valLo}!={valHi} for {l} [FailCt: {failCount}]");
                }

                testCt++;
            }
        });
        if (print) Console.Write($"...Done  Errors so far: {failCount}");


        ///////////////// Verification 7 - Random number testing /////////////////
        if (print) Console.Write($"\r\nVerification 7: Testing Random Numbers:\r\n");
        sw.Restart();
        Parallel.For(0, 32, new ParallelOptions { MaxDegreeOfParallelism = MaxDegreeOfParallelism }, (p, s) =>
        {
            Random r = new(p + RAND_SEED);
            long swNextReport = sw.ElapsedTicks + 200000000L;

            int counter = 0;
            while (true)
            {
                if (!runIndefinitely)
                {
#pragma warning disable CS0162
                    if (sw.ElapsedMilliseconds > (testTimeInSeconds * 1000) * 0.30)
                    {
                        s.Stop();
                        break;
                    }
#pragma warning restore CS0162
                }

                //int bitLenRangeBeg = (int)Math.Log2(4e34) + 10;//BitOperations.Log2((ulong)BruteForceStoppedAt)-1; //(int)Math.Log2(4e254) -3;
                //int bitLenRangeEnd = (int)Math.Log2(4e34) + 12; //1e308

                int bitLenBeg = (randomMinBitSize >= 0) ? randomMinBitSize : (BitOperations.Log2((ulong)BruteForceStoppedAt) - 1); //(int)Math.Log2(4e254) -3;
                int bitLenEnd = randomMaxBitSize;

                int bitLen = r.Next(bitLenBeg, bitLenEnd) + 1;
                int byteCt = (bitLen + 7) / 8;
                byte[] bytes = new byte[byteCt];
                r.NextBytes(bytes);
                bytes[byteCt - 1] |= 0x80;
                bytes[byteCt - 1] >>= 7 - ((bitLen - 1) % 8);
                BigInteger x = new(bytes, true, false);
                //x += counter + p; // a little extra randomness; can cause bitLen to go over.

                if (x < BruteForceStoppedAt)
                {
                    continue;
                }

                BigInteger a01 = Sqrt(x);

                BigInteger lowerBound = a01 * a01;
                BigInteger upperBound = lowerBound + (2 * a01) + 1;

                if (lowerBound > x || upperBound <= x)
                {
                    int offby = 0;
                    for (int i = -32; i < 32; i++)
                    {
                        if (x >= ((a01 + i) * (a01 + i))) //is high
                        {
                            offby = i;
                        }
                    }

                    failCount++;
                    if (print) Console.WriteLine($" {(double)x} !!!!! {(lowerBound > x ? "Lo" : "Hi")}  {x}  {lowerBound - x} offby: {offby} byteCt:{byteCt}"); //   \t {lowerBound} , {a01} , {upperBound}");
                }

                counter++;
                if (print && sw.ElapsedTicks >= swNextReport)
                {
                    swNextReport = 200000000L + (long)(sw.ElapsedTicks * 1.20); 
                    if (print)
                    {
                        Console.WriteLine($"Status {string.Format("{0:T}", DateTime.Now)}: thread:{p,-3}Count:{counter,-8}2^{x.GetBitLength() - 1,6}/{(double)x} fails:{failCount}");
                    }
                }

                testCt++;

            }
        });
        if (print) Console.WriteLine($"Completed tests for {Sqrt.Method.Name} with {failCount} errors. {testCt} tests completed.");

        return ((double)(testCt - failCount)) / testCt;
    }

    private static void NumberRangeTest(BigInteger begAt, BigInteger endAt)
    {

        // x = begAt + ((range/200)/10) * subSize*i[0-(200/10)]  + ((range/200)/10) * j[0-10]

        BigInteger range = endAt - begAt;
        long testCount = 777777777841 / 511;
        long subSize = 133333547 / 31;
        BigInteger skipSize = range / (testCount); //should be a prime number
        for (BigInteger i = (testCount / subSize); i > 0; i--)
        {
            BigInteger section = begAt + skipSize * subSize * i;
            Parallel.For(0, subSize, new ParallelOptions { MaxDegreeOfParallelism = 32 }, (j, s) =>
            {
                BigInteger x = section - skipSize * j;
                double xAsDub = (double)x;

                ///////// The Test code here  /////////
                ulong vInt = (ulong)Math.Sqrt(xAsDub);
                BigInteger val = (vInt + ((ulong)(x / vInt))) >> 1;
                val = (val * val <= x) ? val : val - 1;



                //if(printOutput) Console.WriteLine($"  section {section}  j*skipSize:{j * skipSize}  x:{x}");


                // Check
                BigInteger tmp = val * val;
                if (tmp > x)
                {
                    Console.WriteLine($"val^2 ({tmp}) < x({x})  off%:{((double)(tmp)) / (double)x}");
                    //throw new Exception("Sqrt function had internal error - value too high");
                }
                if ((tmp + 2 * val + 1) <= x)
                {
                    Console.WriteLine($"(val+1)^2({((val + 1) * (val + 1))}) >= x({x})");
                    //throw new Exception("Sqrt function had internal error - value too low");
                }
            });
            Console.WriteLine($"i {i}  section {section}");

        }
        Console.WriteLine($"Done");
    }




    //source: https://github.com/pilotMike/Euler-Challenges-v2/blob/962f981c87e394773507bc00a708fdae202aa61c/EulerTools/Extensions/MyExtensions.cs  Michael DiLeo 2015
    private static bool IsSqrt(BigInteger n, BigInteger root)
    {
        BigInteger lowerBound = root * root;
        BigInteger upperBound = lowerBound + root + root + 1;

        return (n >= lowerBound && n < upperBound);
    }

    private static bool CheckSqrt(BigInteger number, BigInteger sqrt)
    {
        BigInteger margin = number - sqrt * sqrt;
        BigInteger maxError = (sqrt - 1) * 2;
        return (margin > maxError);
    }
}
